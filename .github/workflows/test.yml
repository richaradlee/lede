name: OpenWrt-Build

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: "Enable SSH for debugging"
        required: false
        default: "false"
  repository_dispatch:

env:
  TZ: Asia/Shanghai

  # === 上传控制 ===
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true

  # === 目录路径（统一管理）===
  OWRT_DIR: openwrt
  ARTIFACT_DIR: artifact
  CACHE_PREFIX: ${{ github.workspace }}/openwrt

  # === 编译目标混合 Key (用于 Cache 分层) ===
  MIXKEY: x86_6.12

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ---------------------------------------------------
    #                 最大化磁盘空间
    # ---------------------------------------------------
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 512
        swap-size-mb: 1024
        remove-dotnet: true

    # ---------------------------------------------------
    #                 设置编译时间 & 依赖
    # ---------------------------------------------------
    - name: Setup build env
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3 rsync unzip zlib1g-dev file

        sudo timedatectl set-timezone "$TZ"

    # ---------------------------------------------------
    #                   Cache 加速
    # ---------------------------------------------------
    - name: Cache
      uses: stupidloud/cachewrtbuild@main
      with:
        ccache: true
        toolchain: true
        mixkey: ${{ env.MIXKEY }}
        clean: false
        prefix: ${{ env.CACHE_PREFIX }}
        skip: false
        skip_saving: false

    # ---------------------------------------------------
    #                   更新 & 安装 feeds
    # ---------------------------------------------------
    - name: Update feeds
      run: |
        cd $OWRT_DIR
        ./scripts/feeds update -a

    - name: Install feeds
      run: |
        cd $OWRT_DIR
        ./scripts/feeds install -a

    # ---------------------------------------------------
    #                   加载 .config
    # ---------------------------------------------------
    - name: Load Custom Config
      run: |
        [ -e $OWRT_DIR/.config ] && echo "Using existing .config" || cp config.default $OWRT_DIR/.config

    # ---------------------------------------------------
    #                   SSH 调试
    # ---------------------------------------------------
    - name: Debug via SSH
      if: ${{ github.event.inputs.ssh == 'true' }}
      uses: mxschmitt/action-tmate@v3

    # ---------------------------------------------------
    #                     开始编译
    # ---------------------------------------------------
    - name: Build OpenWrt
      run: |
        cd $OWRT_DIR
        make defconfig
        make -j$(nproc) || make -j1 V=s

    # ---------------------------------------------------
    #                     整理固件
    # ---------------------------------------------------
    - name: Move Firmware
      run: |
        mkdir -p $ARTIFACT_DIR
        find $OWRT_DIR/bin/targets -type f -exec cp {} $ARTIFACT_DIR/ \;

    # ---------------------------------------------------
    #             上传 Artifact (避免重名 409)
    # ---------------------------------------------------
    - name: Upload Firmware Artifact
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_${{ env.MIXKEY }}_${{ github.run_id }}
        path: ${{ env.ARTIFACT_DIR }}/
        if-no-files-found: warn
        compression-level: 6

    # ---------------------------------------------------
    #                   发布 Release
    # ---------------------------------------------------
    - name: Upload Release
      if: env.UPLOAD_RELEASE == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: openwrt-${{ env.MIXKEY }}-${{ github.run_id }}
        name: OpenWrt Firmware ${{ env.MIXKEY }}
        files: ${{ env.ARTIFACT_DIR }}/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
